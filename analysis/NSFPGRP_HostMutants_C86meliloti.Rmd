---
title: "NSFPGRP_HostMutant_C86Meliloti"
author: Regina B. Bledsoe, Liana T. Burghardt, ... 
output: html_notebook
---

Analysis file for NSF Host Mutant C86 Ensifer meliloti select and resequence project. 

```{r setup, include=FALSE}
#This chunk is for setting global options for all chunks
knitr::opts_knit$set(root.dir = '/GitHub')
knitr::opts_chunk$set(message = FALSE)

#Searchable R Markdown reference: https://bookdown.org/yihui/rmarkdown-cookbook/

#Combining plots
#require(ggpubr)
#cfu_combo <- ggarrange(p_cfu_A17, p_cfu_R108, common.legend = TRUE)

#facet zoom
#facet_grid(. ~ background) 
#facet_zoom(ylim = c(1000000, 10000000)) #require(ggforce)) 
```

```{r load_libraries, echo=FALSE, results='hide',include=FALSE}
require(tidyverse)#data manipulation and ggplot
require(ggpubr)#combine plots
require(ggfortify)#heat maps
require(vegan)#ecological statistics

#color palettes - colorblind friendly
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
cbbPalette <- c("#E69F00", "#D55E00","56B4E9" , "#CC79A7", "#009E73", "#0072B2","#F0E442" , "#000000")

# Define a color and shape scheme for the whole manuscript
#mycols<-data.frame(type=c("AOR","Early","4C","Na+","Dry","La","Sm","Clay"), cols=c("#666666","#D95F02", "#7570B3", "#E7298A", "#66A61E", "#E6AB02", "#A6761D", "#1B9E77"))
#mycols$Trt <- factor(mycols$Trt, ordered=TRUE)

#myshapes<-data.frame(Time=c("2wk","10wk","24wk"),shapes=c(1,12,19))
#myshapes$Time <- factor(myshapes$Time, ordered = TRUE)

```

```{r meta_data, include=FALSE}
getwd()
all_data <- read.table("../data/data_nsfpgrp_hostmutants_C86meliloti.txt", sep = "\t", header=TRUE)
geno_name <- read.table("../data/genotype_name.txt", sep = "\t", header=TRUE)

#genotype_id imports as a chr... not sure why but it is int in the all_data table
geno_name$genotype_id = as.integer(geno_name$genotype_id)
#Calculate cfu per plant - divide by 4ml (this is the amount added to nodules to homogenize) then divide by number of plants picked nodules from to get cfu/ml to cfu/plant
#drop_na(num_plants_picked_nods) %>%
all_data <- all_data %>% inner_join(geno_name, by="genotype_id") %>%  mutate(cfu_plant = cfu_ml/4/num_plants_picked_nods, above_plant = above_biomass_g/num_plants, below_plant = below_biomass_g/num_plants, shoot_root = above_plant/below_plant, nod_wt_plant = nodule_weight_g/num_plants_picked_nods, tot_biomass = above_biomass_g + below_biomass_g)

#num_plants_picked_nods for nodule metrics and 
#num_plants for whole plant metrics ie biomass

#Filter out unwanted samples hybrids and unknown genotypes
all_data <- all_data %>% filter(background!="MS") 
#set genotype_id as a factor so will group in plots
all_data$genotype_id = as.factor(all_data$genotype_id)
```
<b>Summary</b>


<b>Results for dilution plating of nodule homogenate.</b> <br/>
(1)Variation among backgrounds and genotypes. (2) Sunn1, Sunn4 are highly numerated with nodules. (3) A17 and R108 wild types show trend that A17 has higher rhizobial load than R108.

This plot depicts cfu per plant for each genotype. 

***
STATS ARE ORDERED BY: BACKGROUND; A17 TYPE THEN TUKEY; R108 TYPE (ONLY TWO wt & early so no tukey)
***
```{r counts_by_nname, echo=FALSE}
#By host genotype
p_cfu<-ggplot(all_data, aes(x=reorder(name,order), y=cfu_plant, fill=type)) +
        scale_y_continuous(trans='log10') +
        labs(x="Plant Genotype",y="log(cfus per plant)")+
        geom_boxplot() +
        geom_point() + 
        coord_flip() +
        scale_color_manual(values=cbPalette) +
        theme_classic() + theme(legend.position="top", text = element_text(size=22))
p_cfu

#If want separate plots for plant backgrounds. Copy and paste plot code from above below the data line here.
#p_cfu_A17<-ggplot(filter(all_data, background!="R108"), aes(x=reorder(name,order), y=cfu_plant)) +
#p_cfu_R108<-ggplot(filter(all_data, background=="R108"), aes(x=reorder(name,order), y=cfu_plant)) + 

ggsave(plot = p_cfu , width = 8, height = 9, dpi = 600, filename = "../figures/cfu_geno.png")

res.aov <- aov(cfu_plant ~ background, data = all_data) #filter(all_data, background=="A17"))
summary(res.aov)

res.aov <- aov(cfu_plant ~ type, data = filter(all_data, background=="A17"))
summary(res.aov)
TukeyHSD(res.aov)

res.aov <- aov(cfu_plant ~ type, data = filter(all_data, background=="R108"))
summary(res.aov)
###Since we know that A17 and R108 are diff would it make sense to test type within each back ground
```

<b>This plot depicts</b> cfu per plant for each host background which could be Medicago truncatula A17 or R108.  
```{r counts_by_host, echo=FALSE}
#By host background
p_bg_cfu<-ggplot(all_data, aes(x=background, y=cfu_plant)) + 
        geom_boxplot(aes(x=background, y=cfu_plant)) +
        geom_jitter(aes(x=background, y=cfu_plant, color=type)) +
        scale_y_continuous(trans='log10') +
        scale_fill_manual(values=c("#D55E00", "#CC79A7")) +
        scale_color_manual(values=cbPalette, ) +
        labs(x="Plant Host",y="log(cfus per plant)") +
        theme_classic() + theme(legend.position="top", text = element_text(size=18))
p_bg_cfu 

ggsave(plot = p_bg_cfu , width = 5.3, height = 5.5, dpi = 600, filename = "../figures/bg_cfu.png")
```

Above ground biomass in grams per plant by genotype and colored by host background.   
```{r aboveground, echo=FALSE}
#By host genotype
p_aBiomass<-ggplot(all_data, aes(x=reorder(name,order), y=above_plant, fill=type)) + 
        labs(x="Plant Host",y="Per Plant Above Biomass (g)") +
        geom_boxplot() +
        geom_point() + 
        coord_flip() +
        scale_color_manual(values=cbPalette) +
        theme_classic() + theme(legend.position="top", text = element_text(size=22))
p_aBiomass 

p_bg_aBiomass<-ggplot(all_data, aes(x=background, y=above_plant)) + 
        geom_boxplot(aes(x=background, y=above_plant)) +
        geom_jitter(aes(x=background, y=above_plant, color=type)) +
        scale_color_manual(values=cbPalette) +
        scale_fill_manual(values=c("#D55E00", "#CC79A7")) +
        labs(x="Plant Host",y="Per Plant Above Biomass (g)")+
        theme_classic() + theme(legend.position="top", text = element_text(size=18))
p_bg_aBiomass 

ggsave(plot = p_aBiomass, width = 8, height = 9, dpi = 600, filename = "../figures/above_biomass.png")

res.aov <- aov(above_plant ~ background, data = all_data) #filter(all_data, background=="A17"))
summary(res.aov)

res.aov <- aov(above_plant ~ type, data = filter(all_data, background=="A17"))
summary(res.aov)
TukeyHSD(res.aov)

res.aov <- aov(above_plant ~ type, data = filter(all_data, background=="R108"))
summary(res.aov)

```

Below ground biomass in grams per plant by genotype and colored by host background.  
```{r belowground, echo=FALSE}
#By host genotype
p_bBiomass<-ggplot(all_data, aes(x=reorder(name,order), y=below_plant)) + 
        geom_boxplot(outlier.shape=NA) +
        geom_jitter(aes(x=name, y=below_plant, color=type)) +
        coord_flip() +
        scale_color_manual(values=cbPalette)  +
        labs(x="Plant Host",y="Per Plant Below Biomass (g)") +
        theme_classic() + theme(legend.position="", text = element_text(size=18))
p_bBiomass 

p_bg_bBiomass<-ggplot(all_data, aes(x=background, y=below_plant)) + 
        geom_boxplot(aes(x=background, y=below_plant)) +
        geom_jitter(aes(x=background, y=below_plant, color=type)) +
        scale_color_manual(values=cbPalette) +
        scale_fill_manual(values=c("#D55E00", "#CC79A7")) +
        labs(x="Plant Host",y="Per Plant Below Biomass (g)")+
        theme_classic() + theme(legend.position="", text = element_text(size=18))
p_bg_bBiomass


ggsave(plot = p_bBiomass, width = 10, height = 10, dpi = 600, filename = "../figures/below_biomass.png")

res.aov <- aov(below_plant ~ background, data = all_data) #filter(all_data, background=="A17"))
summary(res.aov)

res.aov <- aov(below_plant ~ type, data = filter(all_data, background=="A17"))
summary(res.aov)
TukeyHSD(res.aov)

res.aov <- aov(below_plant ~ type, data = filter(all_data, background=="R108"))
summary(res.aov)

```

```{r biomass, echo=FALSE}
p_tot_biomass<-ggplot(all_data, aes(x=reorder(name,order), y=tot_biomass)) + 
        geom_boxplot(outlier.shape=NA) +
        geom_jitter(aes(x=name, y=tot_biomass, color=type)) +
        coord_flip() +
        scale_color_manual(values=cbPalette)  +
        labs(x="Plant Host",y="Total Biomass (g)") +
        theme_classic() + theme(legend.position="", text = element_text(size=18))
p_tot_biomass 

p_bg_tot_biomass<-ggplot(all_data, aes(x=background, y=tot_biomass)) + 
        geom_boxplot(aes(x=background, y=tot_biomass)) +
        geom_jitter(aes(x=background, y=tot_biomass, color=type)) +
        scale_color_manual(values=cbPalette) +
        scale_fill_manual(values=c("#D55E00", "#CC79A7")) +
        labs(x="Plant Host",y="Total Biomass (g)")+
        theme_classic() + theme(legend.position="", text = element_text(size=18))
p_bg_tot_biomass

res.aov <- aov(tot_biomass ~ background, data = all_data) #filter(all_data, background=="A17"))
summary(res.aov)

res.aov <- aov(tot_biomass ~ type, data = filter(all_data, background=="A17"))
summary(res.aov)
TukeyHSD(res.aov)

res.aov <- aov(tot_biomass ~ type, data = filter(all_data, background=="R108"))
summary(res.aov)
```

Shoot to root ratio in grams per plant by genotype and colored by host background.  
```{r shoot_root, echo=FALSE}
#By host genotype
p_shoot_root <-ggplot(all_data, aes(x=reorder(name,order), y=shoot_root, fill=type)) + 
        labs(x="Plant Host",y="Shoot:Root") +
        geom_boxplot() +
        geom_point() + 
        coord_flip() +
        scale_color_manual(values=cbPalette) +
        theme_classic() + theme(legend.position="top", text = element_text(size=22))
p_shoot_root 

p_bg_shoot_root<-ggplot(all_data, aes(x=background, y=shoot_root)) + 
        geom_boxplot(aes(x=background, y=shoot_root)) +
        geom_jitter(aes(x=background, y=shoot_root, color=type)) +
        scale_color_manual(values=cbPalette) +
        scale_fill_manual(values=c("#D55E00", "#CC79A7")) +
        labs(x="Plant Host",y="Shoot:Root")+
        theme_classic() + theme(legend.position="", text = element_text(size=18))
p_bg_shoot_root


ggsave(plot = p_shoot_root , width = 8, height = 9, dpi = 600, filename = "../figures/shoot_root.png")

res.aov <- aov(shoot_root ~ background, data = all_data) #filter(all_data, background=="A17"))
summary(res.aov)

res.aov <- aov(shoot_root ~ type, data = filter(all_data, background=="A17"))
summary(res.aov)
TukeyHSD(res.aov)

res.aov <- aov(shoot_root ~ type, data = filter(all_data, background=="R108"))
summary(res.aov)


```

```{r nodule_data, include=FALSE}
nod_data <- read.table("../data/data_nod_img_measurements.txt", sep = "\t", header=TRUE)
#nod_data$genotype_id = as.factor(nod_data$genotype_id)
all_data <- all_data %>% full_join(nod_data, by="sample_id") %>% mutate(nod_cnt_plant = nod_data$nod_count/num_plants, tot_area_plant = nod_data$nod_total_area_cm2/num_plants )

```

```{r nod count per plant, echo=FALSE}
p_nod_cnt <-ggplot(all_data, aes(x=reorder(name,order), y=nod_cnt_plant)) + 
        geom_boxplot(outlier.shape=NA) +
        geom_jitter(aes(x=name, y=nod_cnt_plant, color=type)) +
        coord_flip() +
        scale_color_manual(values=cbPalette)  +
        labs(x="Plant Host",y="Nods per plant") +
        theme_classic() + theme(legend.position="top", text = element_text(size=18))
p_nod_cnt 

p_bg_nod_cnt <-ggplot(all_data, aes(x=background, y=nod_cnt_plant)) + 
        geom_boxplot(aes(x=background, y=nod_cnt_plant)) +
        geom_jitter(aes(x=background, y=nod_cnt_plant, color=type)) +
        scale_color_manual(values=cbPalette) +
        scale_fill_manual(values=c("#D55E00", "#CC79A7")) +
        labs(x="Plant Host",y="Nods per plant")+
        theme_classic() + theme(legend.position="top", text = element_text(size=18))
p_bg_nod_cnt

ggsave(plot = p_bg_nod_cnt , width = 5, height = 5, dpi = 600, filename = "../figures/bg_nod_cnt.png")

res.aov <- aov(nod_cnt_plant ~ background, data = all_data) #filter(all_data, background=="A17"))
summary(res.aov)

res.aov <- aov(nod_cnt_plant ~ type, data = filter(all_data, background=="A17"))
summary(res.aov)
TukeyHSD(res.aov)

res.aov <- aov(nod_cnt_plant ~ type, data = filter(all_data, background=="R108"))
summary(res.aov)
```

```{r total area of nodules, echo=FALSE}
p_tot_area <-ggplot(all_data, aes(x=reorder(name,order), y=tot_area_plant)) + 
        geom_boxplot(outlier.shape=NA) +
        geom_jitter(aes(x=name, y=tot_area_plant, color=type)) +
        coord_flip() +
        scale_color_manual(values=cbPalette)  +
        labs(x="Plant Host",y="Total Nod Area per plant") +
        theme_classic() + theme(legend.position="top", text = element_text(size=18))
p_tot_area 

p_bg_tot_area <-ggplot(all_data, aes(x=background, y=tot_area_plant)) + 
        geom_boxplot(aes(x=background, y=tot_area_plant)) +
        geom_jitter(aes(x=background, y=tot_area_plant, color=type)) +
        scale_color_manual(values=cbPalette) +
        scale_fill_manual(values=c("#D55E00", "#CC79A7")) +
        labs(x="Plant Host",y="Total Nod area per plant")+
        theme_classic() + theme(legend.position="top", text = element_text(size=18))
p_bg_tot_area

ggsave(plot = p_bg_tot_area , width = 5, height = 5, dpi = 600, filename = "../figures/bg_tot_area.png")

res.aov <- aov(tot_area_plant ~ background, data = all_data) #filter(all_data, background=="A17"))
summary(res.aov)

res.aov <- aov(tot_area_plant ~ type, data = filter(all_data, background=="A17"))
summary(res.aov)
TukeyHSD(res.aov)

res.aov <- aov(tot_area_plant ~ type, data = filter(all_data, background=="R108"))
summary(res.aov)
```

```{r nodule weight, echo=FALSE}
p_nod_wt <-ggplot(all_data[-171,], aes(x=reorder(name,order), y=nod_wt_plant, fill=type)) + 
        labs(x="Plant Host",y="Nod gram per plant") +
        geom_boxplot() +
        geom_point() + 
        coord_flip() +
        scale_color_manual(values=cbPalette) +
        theme_classic() + theme(legend.position="top", text = element_text(size=22))
p_nod_wt 

p_bg_nod_wt <-ggplot(all_data, aes(x=background, y=nod_wt_plant)) + 
        geom_boxplot(aes(x=background, y=nod_wt_plant)) +
        geom_jitter(aes(x=background, y=nod_wt_plant, color=type)) +
        scale_color_manual(values=cbPalette) +
        scale_fill_manual(values=c("#D55E00", "#CC79A7")) +
        labs(x="Plant Host",y="Nod gram per plant")+
        theme_classic() + theme(legend.position="top", text = element_text(size=18))
p_bg_nod_wt

ggsave(plot = p_nod_wt , width = 8, height =9, dpi = 600, filename = "../figures/nod_wt_plant.png")

res.aov <- aov(nod_wt_plant ~ background, data = all_data) #filter(all_data, background=="A17"))
summary(res.aov)

res.aov <- aov(nod_wt_plant ~ type, data = filter(all_data, background=="A17"))
summary(res.aov)
TukeyHSD(res.aov)

res.aov <- aov(nod_wt_plant ~ type, data = filter(all_data, background=="R108"))
summary(res.aov)

```

```{r strain_freq_data, echo=FALSE, warning=FALSE}
#Import data and filter dataset
#geno_name <- read.delim("~/GitHub/HostMutants2021_C86meliloti/data/genotype_name.txt", sep="\t", header=TRUE)
freq_all<-read.table("~/GitHub/HostMutants2021_C86meliloti/data/freq.tsv", header=TRUE)
#C:\Users\Lab Manager\Documents\GitHub\HostMutants2021_C86meliloti\data
#initial = M_C86_NLA-D 
#culture gow-ups = M_C86_TYA-D
#exudate experiment = X_
#alfalfa S&R = M_888-890
#Wild types = M_860, M_869

#Remove initial inoculum community, TY grow-ups, exudate experiment, and wonky alfalfa sample
freq_filtered <- freq_all %>% filter(!str_detect(sample_id, "M_C86_")) %>% filter(!str_detect(sample_id, "X_")) %>% filter(sample_id != "M_888F_S168")

#Calculate Fitness
#Subset initial inoculum community and calculate mean
freq_initial <- freq_all %>% filter(str_detect(sample_id, "M_C86_NL"))
freq_initial_mean <- as_tibble(apply(data.frame(freq_initial[,c(-1:-1)]), MARGIN = 2, mean))

#Transform raw frequency data to fitness data. log2(treatment_freq/initial_freq)
fit<-as_tibble(cbind(freq_filtered[,c(1:1)],log2(mapply("/", freq_filtered[,c(-1:-1)], freq_initial_mean))))

#After running the above line it converts values from num to chr... I think this is because the cbind is joing a chr col and a num col ? Whatever the reason the below 3 lines converts matrix values to num
fit <- as.data.frame(apply(fit, 2, as.numeric))
sample_id <- freq_filtered[,c(1:1)]
fit<- cbind(sample_id, fit[,c(2:87)])

fit <- fit %>% mutate_if(is.numeric, ~ifelse(abs(.) == Inf,-8,.)) 

#Separate sample_id 
fit <- fit %>% mutate(genotype_id = substr(sample_id, 3,5), rep = substr(sample_id, 6,6))
fit$genotype_id <- as.factor(fit$genotype_id)
geno_name$genotype_id <- as.factor(geno_name$genotype_id)
meta_fit <- inner_join(fit, geno_name, by="genotype_id")
```

```{r fit_rda_all, echo=FALSE, fig.width=10, fig.height=15}
# RDA analysis for fitness and plot RDA1 vs RDA2 and RDA3 vs RDA4

# Run a few different RDA Models
rda1<-rda(meta_fit[,c(2:87)]~type+name,meta_fit, scale=TRUE) #Full Model w/ interactions
rda2<-rda(meta_fit[,c(2:87)]~background+name,meta_fit, scale=TRUE) # Additive Model
rda3<-rda(meta_fit[,c(2:87)]~background,meta_fit, scale=TRUE) # Treatment only
rda4<-rda(meta_fit[,c(2:87)]~name,meta_fit, scale=TRUE) # Time only

# Rsquared gives you an overall idea of well the overall model adjusted for the number of predictors you have
mymodels<-data.frame(data=c("all"),model=c("host*geno_type","host+geno_type","host","geno_type"),
           Radj=c(RsquareAdj(rda1)$adj.r.squared,RsquareAdj(rda2)$adj.r.squared,RsquareAdj(rda3)$adj.r.squared,RsquareAdj(rda4)$adj.r.squared),
           Prop.Exp=c(summary(rda1)$constr.chi/summary(rda1)$tot.chi,summary(rda2)$constr.chi/summary(rda2)$tot.chi,summary(rda3)$constr.chi/summary(rda3)$tot.chi,summary(rda4)$constr.chi/summary(rda4)$tot.chi))
mymodels
# The adjusted r-squared for the model allowing for an interaction between Time and Treatment has the highest rsquared even when penalized for the additional predictors
# Run a permutational significance test for the explanatory variables in the full model
# In this case the inference from the anova aligns with the inference from the adjusted R squared 

rda.model.all<-anova(rda1, step=1000, perm.max=1000, by= "terms") # The interaction is significant, but temperature has the largest effect
write.table(rda.model.all,file = "../tables/RDA_All_hostxtype.tsv",sep="\t",col.names = NA,row.names=TRUE)

#Plot the FULL model with the interaction #
smry <- summary(rda4)
df1  <- data.frame(smry$sites[,1:2])       
df2  <- data.frame(smry$species[,1:2])     

rda1_ev <-as.vector(eigenvals(rda1, constrained=TRUE))

#copy sample_id(substring(right, 4)) in to a new column called sample_id
s_id <- substr(meta_fit$sample_id, 3,6)
m_name <- select(meta_fit, name)
m_host <- select(meta_fit, background)
m_type <- select(meta_fit, type)
df1 <- df1 %>% add_column(s_id, m_name, m_host, m_type)


rda.plot <- ggplot(df1, aes(x=RDA1, y=RDA2)) + 
  geom_point(aes(shape=background, color=type), size=4)+
  scale_shape_manual(values=c(15, 16, 17, 18))+
  geom_text(aes(label=name),size=4) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  labs(x=paste("RDA 1 (",round(rda1_ev[1],2),"%)"),y=paste("RDA 2 (",round(rda1_ev[2],2),"%)")) +
  theme_classic() + theme(legend.position="top", text = element_text(size=14))
rda.plot
#ggsave("../figures/rda_plot.png", rda.plot, height = 12 , width = 12, dpi=300)

#rda.biplot <- rda.plot +
#  geom_segment(data=df2, aes(x=0, xend=RDA1, y=0, yend=RDA2), 
#               color="red", arrow=arrow(length=unit(0.01,"npc"))) +
#  geom_text(data=df2, 
#            aes(x=RDA1,y=RDA2,label=rownames(df2),
#                hjust=0.5*(1-sign(RDA1)),vjust=0.5*(1-sign(RDA2))), 
#            color="red", size=4)
#rda.biplot

```


```{r fit_rda_r108, echo=FALSE}
# RDA analysis for fitness and plot RDA1 vs RDA2 and RDA3 vs RDA4
meta_fit_r108 <- meta_fit %>% filter(background=="R108") %>% filter(type!="KO/OX")
# Run a few different RDA Models
rda1<-rda(meta_fit_r108[,c(2:87)]~type,meta_fit_r108, scale=TRUE) # Time only
rda2<-rda(meta_fit_r108[,c(2:87)]~name,meta_fit_r108, scale=TRUE) # Time only
rda3<-rda(meta_fit_r108[,c(2:87)]~type*name,meta_fit_r108, scale=TRUE) # Time only
rda4<-rda(meta_fit_r108[,c(2:87)]~type+name,meta_fit_r108, scale=TRUE) # Time only
# Rsquared gives you an overall idea of well the overall model adjusted for the number of predictors you have
mymodels<-data.frame(data=c("R108"),model=c("genotype"),
           Radj=c(RsquareAdj(rda1)$adj.r.squared),
           Prop.Exp=c(summary(rda1)$constr.chi/summary(rda1)$tot.chi))
mymodels
# The adjusted r-squared for the model allowing for an interaction between Time and Treatment has the highest rsquared even when penalized for the additional predictors
# Run a permutational significance test for the explanatory variables in the full model
# In this case the inference from the anova aligns with the inference from the adjusted R squared 

rda.model.all<-anova(rda1, step=1000, perm.max=1000, by= "terms") # The interaction is significant, but temperature has the largest effect
write.table(rda.model.all,file = "../tables/RDA_r108_type.tsv",sep="\t",col.names = NA,row.names=TRUE)

#Plot the FULL model with the interaction #
smry <- summary(rda2)
df1  <- data.frame(smry$sites[,1:2])       # PC1 and PC2
#df2  <- data.frame(smry$species[,1:2])     # loadings for PC1 and PC2

#copy sample_id(substring(right, 4)) in to a new column called sample_id
m_name <- select(filter(meta_fit,background=="R108" & type!="KO/OX"), name)
m_type <- select(filter(meta_fit,background=="R108" & type!="KO/OX"), type)
df1 <- df1 %>% add_column(m_name, m_type)

rda1_ev <-as.vector(eigenvals(rda2, constrained=TRUE))

rda.plot <- ggplot(df1, aes(x=RDA1, y=RDA2)) + 
  geom_point(aes(color=type), size=4)+
  scale_shape_manual(values=c(15, 16, 17, 18))+
  geom_text(aes(label=name),size=4) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  coord_fixed() +
  labs(x=paste("RDA 1 (",round(rda1_ev[1],2),"%)"),y=paste("RDA 2 (",round(rda1_ev[2],2),"%)")) +
  theme_classic() + theme(legend.position="top", text = element_text(size=14))
rda.plot
ggsave("../figures/rda_r108.png", rda.plot, height = 6 , width = 8, dpi=300)
```

```{r fit_rda_a17_dnf, echo=FALSE}
# RDA analysis for fitness and plot RDA1 vs RDA2 and RDA3 vs RDA4
meta_fit_a17_dnf <- meta_fit %>% filter(background=="A17") %>% filter(str_detect(name,"dnf")|name=)
# Run a few different RDA Models
rda1<-rda(meta_fit_a17_dnf[,c(2:87)]~name,meta_fit_a17_dnf, scale=TRUE) # Time only
#rda2<-rda(meta_fit_a17[,c(2:87)]~type,meta_fit_a17, scale=TRUE) # Time only
#rda3<-rda(meta_fit_a17[,c(2:87)]~type+name,meta_fit_a17, scale=TRUE) # Time only
#rda4<-rda(meta_fit_a17[,c(2:87)]~type+name,meta_fit_a17, scale=TRUE) # Time only
# Rsquared gives you an overall idea of well the overall model adjusted for the number of predictors you have
mymodels<-data.frame(data=c("dnf"),model=c("genotype","type","type+genotype"),
          Radj=c(RsquareAdj(rda1)$adj.r.squared),
           Prop.Exp=c(summary(rda1)$constr.chi/summary(rda1)$tot.chi))
mymodels
# The adjusted r-squared for the model allowing for an interaction between Time and Treatment has the highest rsquared even when penalized for the additional predictors
# Run a permutational significance test for the explanatory variables in the full model
# In this case the inference from the anova aligns with the inference from the adjusted R squared 

rda.model.all<-anova(rda1, step=1000, perm.max=1000, by= "terms") # The interaction is significant, but temperature has the largest effect
rda.model.all
write.table(rda.model.all,file = "../tables/RDA_a17_type.tsv",sep="\t",col.names = NA,row.names=TRUE)

#Plot the FULL model with the interaction #
smry <- summary(rda1)
df1  <- data.frame(smry$sites[,1:2])       # PC1 and PC2
#df2  <- data.frame(smry$species[,1:2])     # loadings for PC1 and PC2

#copy sample_id(substring(right, 4)) in to a new column called sample_id
m_name <- select(meta_fit_a17_dnf, name)
m_type <- select(meta_fit_a17_dnf, type)
df1 <- df1 %>% add_column(m_name, m_type)

rda1_ev <-as.vector(eigenvals(rda1, constrained=TRUE))

rda.plot <- ggplot(df1, aes(x=RDA1, y=RDA2)) + 
  geom_point(aes(color=type), size=4)+
  scale_shape_manual(values=c(15, 16, 17, 18))+
  geom_text(aes(label=name),size=4) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  coord_fixed() +
  labs(x=paste("RDA 1 (",round(rda1_ev[1],2),"%)"),y=paste("RDA 2 (",round(rda1_ev[2],2),"%)")) +
  theme_classic() + theme(legend.position="top", text = element_text(size=14))
rda.plot
ggsave("../figures/rda_a17_dnf.png", rda.plot, height = 6 , width = 8, dpi=300)
```
```{r fit_rda_a17, echo=FALSE}
# RDA analysis for fitness and plot RDA1 vs RDA2 and RDA3 vs RDA4
meta_fit_a17 <- meta_fit %>% filter(background=="A17")
# Run a few different RDA Models
rda1<-rda(meta_fit_a17[,c(2:87)]~name,meta_fit_a17, scale=TRUE) # Time only
rda2<-rda(meta_fit_a17[,c(2:87)]~type,meta_fit_a17, scale=TRUE) # Time only
rda3<-rda(meta_fit_a17[,c(2:87)]~type+name,meta_fit_a17, scale=TRUE) # Time only
#rda4<-rda(meta_fit_a17[,c(2:87)]~type+name,meta_fit_a17, scale=TRUE) # Time only
# Rsquared gives you an overall idea of well the overall model adjusted for the number of predictors you have
mymodels<-data.frame(data=c("A17"),model=c("genotype","type","type+genotype"),
          Radj=c(RsquareAdj(rda1)$adj.r.squared,RsquareAdj(rda2)$adj.r.squared,RsquareAdj(rda3)$adj.r.squared),
           Prop.Exp=c(summary(rda1)$constr.chi/summary(rda1)$tot.chi,summary(rda2)$constr.chi/summary(rda2)$tot.chi,summary(rda3)$constr.chi/summary(rda3)$tot.chi))
mymodels
# The adjusted r-squared for the model allowing for an interaction between Time and Treatment has the highest rsquared even when penalized for the additional predictors
# Run a permutational significance test for the explanatory variables in the full model
# In this case the inference from the anova aligns with the inference from the adjusted R squared 

rda.model.all<-anova(rda1, step=1000, perm.max=1000, by= "terms") # The interaction is significant, but temperature has the largest effect
write.table(rda.model.all,file = "../tables/RDA_a17_type.tsv",sep="\t",col.names = NA,row.names=TRUE)

#Plot the FULL model with the interaction #
smry <- summary(rda1)
df1  <- data.frame(smry$sites[,1:2])       # PC1 and PC2
#df2  <- data.frame(smry$species[,1:2])     # loadings for PC1 and PC2

#copy sample_id(substring(right, 4)) in to a new column called sample_id
m_name <- select(filter(meta_fit,background=="A17"), name)
m_type <- select(filter(meta_fit,background=="A17"), type)
df1 <- df1 %>% add_column(m_name, m_type)

rda1_ev <-as.vector(eigenvals(rda1, constrained=TRUE))

rda.plot <- ggplot(df1, aes(x=RDA1, y=RDA2)) + 
  geom_point(aes(color=type), size=4)+
  scale_shape_manual(values=c(15, 16, 17, 18))+
  geom_text(aes(label=name),size=4) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  coord_fixed() +
  labs(x=paste("RDA 1 (",round(rda1_ev[1],2),"%)"),y=paste("RDA 2 (",round(rda1_ev[2],2),"%)")) +
  theme_classic() + theme(legend.position="top", text = element_text(size=14))
rda.plot
ggsave("../figures/rda_a17.png", rda.plot, height = 6 , width = 8, dpi=300)
```

```{r fit_rda_MS, echo=FALSE}
# RDA analysis for fitness and plot RDA1 vs RDA2 and RDA3 vs RDA4
meta_fit_MS <- meta_fit %>% filter(background=="MS") %>% filter(type!="UN")
# Run a few different RDA Models
#rda1<-rda(meta_fit_MS[,c(2:87)]~type,meta_fit_MS, scale=TRUE) # Time only
rda1<-rda(meta_fit_MS[,c(2:87)]~name,meta_fit_MS, scale=TRUE) # Time only
#rda3<-rda(meta_fit_MS[,c(2:87)]~type*name,meta_fit_MS, scale=TRUE) # Time only
#rda4<-rda(meta_fit_MS[,c(2:87)]~type+name,meta_fit_MS, scale=TRUE) # Time only
# Rsquared gives you an overall idea of well the overall model adjusted for the number of predictors you have
mymodels<-data.frame(data=c("all"),model=c("genotype"),
           Radj=c(RsquareAdj(rda1)$adj.r.squared),
           Prop.Exp=c(summary(rda1)$constr.chi/summary(rda1)$tot.chi))
mymodels
# The adjusted r-squared for the model allowing for an interaction between Time and Treatment has the highest rsquared even when penalized for the additional predictors
# Run a permutational significance test for the explanatory variables in the full model
# In this case the inference from the anova aligns with the inference from the adjusted R squared 

rda.model.all<-anova(rda1, step=1000, perm.max=1000, by= "terms") # The interaction is significant, but temperature has the largest effect
write.table(rda.model.all,file = "../tables/RDA_MS_type.tsv",sep="\t",col.names = NA,row.names=TRUE)

#Plot the FULL model with the interaction #
smry <- summary(rda1)
df1  <- data.frame(smry$sites[,1:2])       # PC1 and PC2
#df2  <- data.frame(smry$species[,1:2])     # loadings for PC1 and PC2

#copy sample_id(substring(right, 4)) in to a new column called sample_id
m_name <- select(filter(meta_fit,background=="MS" & type!="UN"), name)
m_type <- select(filter(meta_fit,background=="MS" & type!="UN"), type)
df1 <- df1 %>% add_column(m_name, m_type)

rda1_ev <-as.vector(eigenvals(rda1, constrained=TRUE))

rda.plot <- ggplot(df1, aes(x=RDA1, y=RDA2)) + 
  geom_point(aes(color=type), size=4)+
  scale_shape_manual(values=c(15, 16, 17, 18))+
  geom_text(aes(label=name),size=4) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  coord_fixed() +
  labs(x=paste("RDA 1 (",round(rda1_ev[1],2),"%)"),y=paste("RDA 2 (",round(rda1_ev[2],2),"%)")) +
  theme_classic() + theme(legend.position="top", text = element_text(size=14))
rda.plot
ggsave("../figures/rda_MS.png", rda.plot, height = 15 , width = 10, dpi=300)
```

```{r fit_rda_NILS, echo=FALSE}
# RDA analysis for fitness and plot RDA1 vs RDA2 and RDA3 vs RDA4
meta_fit_A18 <- meta_fit %>% filter(background=="NILS") %>% filter(type!="UN")
# Run a few different RDA Models
#rda1<-rda(meta_fit_A18[,c(2:87)]~type,meta_fit_A18, scale=TRUE) # Time only
rda1<-rda(meta_fit_A18[,c(2:87)]~name,meta_fit_A18, scale=TRUE) # Time only
#rda3<-rda(meta_fit_A18[,c(2:87)]~type*name,meta_fit_A18, scale=TRUE) # Time only
#rda4<-rda(meta_fit_A18[,c(2:87)]~type+name,meta_fit_A18, scale=TRUE) # Time only
# Rsquared gives you an overall idea of well the overall model adjusted for the number of predictors you have
mymodels<-data.frame(data=c("NILS"),model=c("genotype"),
           Radj=c(RsquareAdj(rda1)$adj.r.squared),
           Prop.Exp=c(summary(rda1)$constr.chi/summary(rda1)$tot.chi))
mymodels
# The adjusted r-squared for the model allowing for an interaction between Time and Treatment has the highest rsquared even when penalized for the additional predictors
# Run a permutational significance test for the explanatory variables in the full model
# In this case the inference from the anova aligns with the inference from the adjusted R squared 

rda.model.all<-anova(rda1, step=1000, perm.max=1000, by= "terms") # The interaction is significant, but temperature has the largest effect
write.table(rda.model.all,file = "../tables/RDA_A18_type.tsv",sep="\t",col.names = NA,row.names=TRUE)

#Plot the FULL model with the interaction #
smry <- summary(rda1)
df1  <- data.frame(smry$sites[,1:2])       # PC1 and PC2
#df2  <- data.frame(smry$species[,1:2])     # loadings for PC1 and PC2

#copy sample_id(substring(right, 4)) in to a new column called sample_id
m_name <- select(filter(meta_fit,background=="NILS" & type!="UN"), name)
m_type <- select(filter(meta_fit,background=="NILS" & type!="UN"), type)
df1 <- df1 %>% add_column(m_name, m_type)

rda1_ev <-as.vector(eigenvals(rda1, constrained=TRUE))

rda.plot <- ggplot(df1, aes(x=RDA1, y=RDA2)) + 
  geom_point(aes(color=type), size=4)+
  scale_shape_manual(values=c(15, 16, 17, 18))+
  geom_text(aes(label=name),size=4) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  coord_fixed() +
  labs(x=paste("RDA 1 (",round(rda1_ev[1],2),"%)"),y=paste("RDA 2 (",round(rda1_ev[2],2),"%)")) +
  theme_classic() + theme(legend.position="top", text = element_text(size=14))
rda.plot
ggsave("../figures/rda_NILS.png", rda.plot, height = 6 , width = 8, dpi=300)
```


```{r fit_rda_ko, echo=FALSE}
# RDA analysis for fitness and plot RDA1 vs RDA2 and RDA3 vs RDA4
meta_fit_ko <- meta_fit %>% filter(type=="KO/OX")
# Run a few different RDA Models
rda1<-rda(meta_fit_ko[,c(2:87)]~name,meta_fit_ko, scale=TRUE) # Time only
#rda2<-rda(meta_fit_ko[,c(2:87)]~type,meta_fit_ko, scale=TRUE) # Time only
#rda3<-rda(meta_fit_ko[,c(2:87)]~type+name,meta_fit_ko, scale=TRUE) # Time only
#rda4<-rda(meta_fit_ko[,c(2:87)]~type+name,meta_fit_ko, scale=TRUE) # Time only
# Rsquared gives you an overall idea of well the overall model adjusted for the number of predictors you have
mymodels<-data.frame(data=c("KO/OX"),model=c("genotype"),
           Radj=c(RsquareAdj(rda1)$adj.r.squared),
           Prop.Exp=c(summary(rda1)$constr.chi/summary(rda1)$tot.chi))
mymodels
# The adjusted r-squared for the model allowing for an interaction between Time and Treatment has the highest rsquared even when penalized for the additional predictors
# Run a permutational significance test for the explanatory variables in the full model
# In this case the inference from the anova aligns with the inference from the adjusted R squared 

rda.model.all<-anova(rda1, step=1000, perm.max=1000, by= "terms") # The interaction is significant, but temperature has the largest effect
rda.model.all
write.table(rda.model.all,file = "../tables/RDA_ko_genotype.tsv",sep="\t",col.names = NA,row.names=TRUE)

#Plot the FULL model with the interaction #
smry <- summary(rda1)
df1  <- data.frame(smry$sites[,1:4])       # PC1 and PC2
#df2  <- data.frame(smry$species[,1:4])     # loadings for PC1 and PC2

#copy sample_id(substring(right, 4)) in to a new column called sample_id
m_name <- select(filter(meta_fit, type=="KO/OX"), name)
m_type <- select(filter(meta_fit,type=="KO/OX"), type)
df1 <- df1 %>% add_column(m_name, m_type)

rda1_ev <-as.vector(eigenvals(rda1, constrained=TRUE))

rda.plot <- ggplot(df1, aes(x=RDA1, y=RDA2)) + 
  geom_point(aes(color=type), size=4)+
  scale_shape_manual(values=c(15, 16, 17, 18))+
  geom_text(aes(label=name),size=4) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  coord_fixed() +
  labs(x=paste("RDA 1 (",round(rda1_ev[1],2),"%)"),y=paste("RDA 2 (",round(rda1_ev[2],2),"%)")) +
  theme_classic() + theme(legend.position="top", text = element_text(size=14))
rda.plot
ggsave("../figures/rda_ko.png", rda.plot, height = 6 , width = 8, dpi=300)

rda.plot <- ggplot(df1, aes(x=RDA1, y=RDA3)) + 
  geom_point(aes(color=type), size=4)+
  scale_shape_manual(values=c(15, 16, 17, 18))+
  geom_text(aes(label=name),size=4) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  coord_fixed() +
  labs(x=paste("RDA 1 (",round(rda1_ev[1],1),"%)"),y=paste("RDA 3 (",round(rda1_ev[2],3),"%)")) +
  theme_classic() + theme(legend.position="top", text = element_text(size=14))
rda.plot
```


```{r freq_diversity, echo=FALSE}
#freq table with sample info
#Separate sample_id 
freq <- freq_filtered %>% mutate(genotype_id = substr(sample_id, 3,5), rep = substr(sample_id, 6,6)) 
freq <- inner_join(freq, geno_name, by="genotype_id") 
freq<- freq %>% filter(type!="UN") %>% filter(background!="MS")

freq_div <-data.frame(shannon=diversity(as.matrix(freq[,c(-1:-1,-87:-93)]), index = "shannon"),Trt=factor(freq$background),Type=factor(freq$type), genotype_id=factor(freq$genotype_id))

freq_div <- inner_join(freq_div, geno_name)

invsimpson = diversity(as.matrix(freq[,c(-1:-1,-87:-93)]), index = "invsimpson")
freq_div <- freq_div %>% add_column(invsimp = invsimpson)

anova(lm(shannon~Trt*Type,data=freq_div)) # First pass anova shows 
summary(lm(shannon~Trt*Type,data=freq_div)) # Examination of coeffecients suggests T

anova(lm(invsimpson~Trt*Type,data=freq_div)) # First pass anova shows 
summary(lm(invsimpson~Trt*Type,data=freq_div)) # Examination of coeffecients suggests T

p<-ggplot(data=freq_div, aes(x=reorder(name, order), y=shannon, fill=type)) +
  geom_boxplot() +
  geom_point() + 
  coord_flip() +
  scale_color_manual(values=cbPalette) +
  labs(x="Plant Host",y="Shannon diversity") +
  theme_classic() + theme(legend.position="top", text = element_text(size=22))
  #theme_classic() + theme(legend.position="top", text = element_text(size=18), axis.text.x = element_text(angle = 45, hjust=1)) #h=6, w=8.4
#opts(axis.title.x = theme_text(vjust=-0.5))
  #facet_grid(~.Trt)
p
ggsave("../figures/shannon.png", p, height = 9 , width = 8, dpi=300)

p<-ggplot(data=freq_div, aes(x=reorder(name, order), y=invsimpson, fill=Type)) +
  geom_boxplot() +
  geom_point() +
  scale_color_manual(values=cbPalette, ) +
  coord_flip() +
  theme_classic()
p
ggsave("../figures/invsimpson.png", p, height = 10 , width = 10, dpi=300)
```

```{r heatmap_means, echo=FALSE}
#HEAT MAP

####NEED TO MAKE THIS MEANS
#Calculate median fitness and plot PCA
#Take Median of fitness
fit.med <- meta_fit_a17_dnf %>% group_by(name) %>% summarise_if(is.numeric,median)
df_long <- pivot_longer(fit.med[,1:87],"MAG5":"MAG761A", names_to="Mag", values_to="value")
#!religion, names_to = "income", values_to = "count")
#df_long <- inner_join(df_long, geno_name, by="genotype_id")
#colnames(df) <- c("x", "y", "value")


p<- ggplot(df_long, aes(x = name, y = Mag, fill = value)) +
  geom_tile(color = "black") +
  scale_fill_viridis_b()
p

ggsave(plot = p , width = 12, height = 12, dpi = 600, filename = "../figures/heat_a17_dnf.png")
```
