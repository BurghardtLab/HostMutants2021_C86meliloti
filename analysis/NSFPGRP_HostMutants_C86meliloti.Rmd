---
title: "NSFPGRP_HostMutant_C86Meliloti"
author: Regina B. Bledsoe, Liana T. Burghardt, ... 
output: html_notebook
---

Analysis file for NSF Host Mutant C86 Ensifer meliloti select and resequence project. 

```{r setup, include=FALSE}
#This chunk is for setting global options for all chunks
knitr::opts_knit$set(root.dir = '/GitHub')
knitr::opts_chunk$set(message = FALSE)

#Searchable R Markdown reference: https://bookdown.org/yihui/rmarkdown-cookbook/

#Combining plots
#require(ggpubr)
#cfu_combo <- ggarrange(p_cfu_A17, p_cfu_R108, common.legend = TRUE)

#facet zoom
#facet_grid(. ~ background) 
#facet_zoom(ylim = c(1000000, 10000000)) #require(ggforce)) 
```

```{r load_libraries, echo=FALSE, results='hide',include=FALSE}
require(tidyverse)#data manipulation and ggplot
require(ggpubr)#combine plots
#require(ggfortify)#heat maps
require(vegan)#ecological statistics
require(RColorBrewer)#color Palettes 
require("gplots")#heat maps

### For emulating ggplot colors ###
gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}
mypal<-gg_color_hue(6)

#color palette for standard plots - colorblind friendly
cbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#CC79A7", "#999999")
cbbPalette <- c("#E69F00", "#D55E00","56B4E9" , "#CC79A7", "#009E73", "#0072B2","#F0E442" , "#000000", "#999999")

#Allows visualization of a color Palette
#require(scales)
#show_col(cbPalette)

# Define a color and shape scheme for the whole manuscript
mycols<-data.frame(type=c("AOR","Early","KO/OX","Late", "NILS","WT"), cols=cbPalette)
mycols$type <- factor(mycols$type, ordered=TRUE)

myshapes<-data.frame(background=c("A17","R108","MS", "NILS"),shapes=c(15, 16, 8, 11))
myshapes$background <- factor(myshapes$background, ordered = TRUE)

```

```{r meta_data, include=FALSE}
getwd()
all_data <- read.table("../data/data_nsfpgrp_hostmutants_C86meliloti.txt", sep = "\t", header=TRUE)
geno_name <- read.table("../data/genotype_name.txt", sep = "\t", header=TRUE)

#genotype_id imports as a chr... not sure why but it is int in the all_data table
geno_name$genotype_id = as.integer(geno_name$genotype_id)
#Calculate cfu per plant - divide by 4ml (this is the amount added to nodules to homogenize) then divide by number of plants picked nodules from to get cfu/ml to cfu/plant
#drop_na(num_plants_picked_nods) %>%
all_data <- all_data %>% inner_join(geno_name, by="genotype_id") %>%  mutate(cfu_plant = cfu_ml/4/num_plants_picked_nods, above_plant = above_biomass_g/num_plants, below_plant = below_biomass_g/num_plants, shoot_root = above_plant/below_plant, nod_wt_plant = nodule_weight_g/num_plants_picked_nods, tot_biomass = above_biomass_g + below_biomass_g)

#num_plants_picked_nods for nodule metrics and 
#num_plants for whole plant metrics ie biomass

#Filter out unwanted samples 
all_data <- all_data %>% filter(background!="MS") 
#MS data in a separate file...
#set genotype_id as a factor so will group in plots or name better?
all_data$name = as.factor(all_data$name)
```
<b>Summary</b>


<b>Results for dilution plating of nodule homogenate.</b> <br/>
(1)Variation among backgrounds and genotypes. (2) Sunn1, Sunn4 are highly numerated with nodules. (3) A17 and R108 wild types show trend that A17 has higher rhizobial load than R108.

This plot depicts cfu per plant for each genotype. 

***
STATS ARE ORDERED BY: BACKGROUND; A17 TYPE THEN TUKEY; R108 TYPE (ONLY TWO wt & early so no tukey)
***
```{r counts_by_name, echo=FALSE}
#By host genotype
p_cfu<-ggplot(all_data, aes(x=reorder(name,order), y=cfu_plant, fill=type)) +
        scale_y_continuous(trans='log10') +
        labs(x="Plant Genotype",y="Population Size (log cfu/plant)")+
        geom_boxplot() +
        geom_point() + 
        coord_flip() +
        scale_fill_manual(values = mycols$cols) +
        theme_classic() + theme(legend.position="top", text = element_text(size=22))

p_cfu

#If want separate plots for plant backgrounds. Copy and paste plot code from above below the data line here.
#p_cfu_A17<-ggplot(filter(all_data, background!="R108"), aes(x=reorder(name,order), y=cfu_plant)) +
#p_cfu_R108<-ggplot(filter(all_data, background=="R108"), aes(x=reorder(name,order), y=cfu_plant)) + 

ggsave(plot = p_cfu , width = 8, height = 9, dpi = 600, filename = "../figures/cfu_geno.png")

res.aov <- aov(cfu_plant ~ background, data = all_data) #filter(all_data, background=="A17"))
summary(res.aov)

res.aov <- aov(cfu_plant ~ type, data = filter(all_data, background=="A17"))
summary(res.aov)
TukeyHSD(res.aov)

res.aov <- aov(cfu_plant ~ name, data = filter(all_data, background=="R108"))
summary(res.aov)
###Since we know that A17 and R108 are diff would it make sense to test type within each back ground
```

  
```{r counts_by_host, include=FALSE}
#<b>This plot depicts</b> cfu per plant for each host background which could be Medicago truncatula A17 or R108.
#By host background
p_bg_cfu<-ggplot(all_data, aes(x=background, y=cfu_plant)) + 
        geom_boxplot(aes(x=background, y=cfu_plant)) +
        geom_jitter(aes(x=background, y=cfu_plant, color=type)) +
        scale_y_continuous(trans='log10') +
        scale_color_manual(values = mycols$cols)  +
        labs(x="Plant Host",y="log cfu/plant") +
        theme_classic() + theme(legend.position="top", text = element_text(size=18))
p_bg_cfu 

##ggsave(plot = p_bg_cfu , width = 5.3, height = 5.5, dpi = 600, filename = "../figures/bg_cfu.png")
```

Above ground biomass in grams per plant by genotype and colored by host background.   
```{r aboveground, echo=FALSE}
#By host genotype
p_aBiomass<-ggplot(all_data, aes(x=reorder(name,order), y=above_plant, fill=type)) + 
        labs(x="Plant Genotype",y="Shoot Biomass (g/plant)") +
        geom_boxplot() +
        geom_point() + 
        coord_flip() +
        scale_fill_manual(values = mycols$cols) +
        theme_classic() + theme(legend.position="top", text = element_text(size=22))
p_aBiomass 

p_bg_aBiomass<-ggplot(all_data, aes(x=background, y=above_plant)) + 
        geom_boxplot(aes(x=background, y=above_plant)) +
        geom_jitter(aes(x=background, y=above_plant, color=type)) +
        scale_color_manual(values = mycols$cols) +
        labs(x="Plant Host",y="Per Plant Above Biomass (g)")+
        theme_classic() + theme(legend.position="top", text = element_text(size=18))
p_bg_aBiomass 

ggsave(plot = p_aBiomass, width = 8, height = 9, dpi = 600, filename = "../figures/above_biomass.png")

res.aov <- aov(above_plant ~ background, data = all_data) #filter(all_data, background=="A17"))
summary(res.aov)

res.aov <- aov(above_plant ~ type, data = filter(all_data, background=="A17"))
summary(res.aov)
TukeyHSD(res.aov)

res.aov <- aov(above_plant ~ type, data = filter(all_data, background=="R108"))
summary(res.aov)

```

Below ground biomass in grams per plant by genotype and colored by host background.  
```{r belowground, echo=FALSE}
#By host genotype
p_bBiomass<-ggplot(all_data, aes(x=reorder(name,order), y=below_plant, fill=type)) + 
        geom_boxplot(outlier.shape=NA) +
        geom_jitter() +
        coord_flip() +
        scale_fill_manual(values = mycols$cols) +  
        labs(x="Plant Genotype",y="Root Biomass (g/plant)") +
        theme_classic() + theme(legend.position="top", text = element_text(size=18))
p_bBiomass 

p_bg_bBiomass<-ggplot(all_data, aes(x=background, y=below_plant)) + 
        geom_boxplot(aes(x=background, y=below_plant)) +
        geom_jitter(aes(x=background, y=below_plant, color=type)) +
        scale_color_manual(values = mycols$cols) +
        labs(x="Plant Host",y="Per Plant Below Biomass (g)")+
        theme_classic() + theme(legend.position="top", text = element_text(size=18))
p_bg_bBiomass


ggsave(plot = p_bBiomass, width = 10, height = 10, dpi = 600, filename = "../figures/below_biomass.png")

res.aov <- aov(below_plant ~ background, data = all_data) #filter(all_data, background=="A17"))
summary(res.aov)

res.aov <- aov(below_plant ~ type, data = filter(all_data, background=="A17"))
summary(res.aov)
TukeyHSD(res.aov)

res.aov <- aov(below_plant ~ type, data = filter(all_data, background=="R108"))
summary(res.aov)

```

```{r biomass, inlcude=FALSE}
p_tot_biomass<-ggplot(all_data, aes(x=reorder(name,order), y=tot_biomass, fill=type)) + 
        geom_boxplot(outlier.shape=NA) +
        geom_jitter() +
        coord_flip() +
        scale_fill_manual(values = mycols$cols) +
        labs(x="Plant Genotype",y="Total Biomass (g)") +
        theme_classic() + theme(legend.position="", text = element_text(size=18))
p_tot_biomass 

p_bg_tot_biomass<-ggplot(all_data, aes(x=background, y=tot_biomass)) + 
        geom_boxplot(aes(x=background, y=tot_biomass)) +
        geom_jitter(aes(x=background, y=tot_biomass, color=type)) +
        scale_color_manual(values = mycols$cols) +
        labs(x="Plant Host",y="Total Biomass (g)")+
        theme_classic() + theme(legend.position="", text = element_text(size=18))
p_bg_tot_biomass

ggsave(plot = p_tot_biomass, width = 10, height = 10, dpi = 600, filename = "../figures/total_biomass.png")

res.aov <- aov(tot_biomass ~ background, data = all_data) #filter(all_data, background=="A17"))
summary(res.aov)

res.aov <- aov(tot_biomass ~ type, data = filter(all_data, background=="A17"))
summary(res.aov)
TukeyHSD(res.aov)

res.aov <- aov(tot_biomass ~ type, data = filter(all_data, background=="R108"))
summary(res.aov)
```

Shoot to root ratio in grams per plant by genotype and colored by host background.  
```{r shoot_root, echo=FALSE}
#By host genotype
p_shoot_root <-ggplot(all_data, aes(x=reorder(name,order), y=shoot_root, fill=type)) + 
        labs(x="Plant Genotype",y="Shoot:Root") +
        geom_boxplot() +
        geom_point() + 
        coord_flip() +
        scale_fill_manual(values = mycols$cols) +
        theme_classic() + theme(legend.position="top", text = element_text(size=22))
p_shoot_root 

p_bg_shoot_root<-ggplot(all_data, aes(x=background, y=shoot_root)) + 
        geom_boxplot(aes(x=background, y=shoot_root)) +
        geom_jitter(aes(x=background, y=shoot_root, color=type)) +
        scale_color_manual(values=cbPalette) +
        scale_fill_manual(values=c("#D55E00", "#CC79A7")) +
        labs(x="Plant Host",y="Shoot:Root")+
        theme_classic() + theme(legend.position="", text = element_text(size=18))
p_bg_shoot_root


ggsave(plot = p_shoot_root , width = 8, height = 9, dpi = 600, filename = "../figures/shoot_root.png")

res.aov <- aov(shoot_root ~ background, data = all_data) #filter(all_data, background=="A17"))
summary(res.aov)

res.aov <- aov(shoot_root ~ type, data = filter(all_data, background=="A17"))
summary(res.aov)
TukeyHSD(res.aov)

res.aov <- aov(shoot_root ~ type, data = filter(all_data, background=="R108"))
summary(res.aov)


```

```{r nodule_data, include=FALSE}
nod_data <- read.table("../data/data_nod_img_measurements.txt", sep = "\t", header=TRUE)
#nod_data$genotype_id = as.factor(nod_data$genotype_id)
all_data <- all_data %>% full_join(nod_data, by="sample_id") %>% mutate(nod_cnt_plant = nod_data$nod_count/num_plants, tot_area_plant = nod_data$nod_total_area_cm2/num_plants )

```

```{r nod count per plant, echo=FALSE}
p_nod_cnt <-ggplot(all_data, aes(x=reorder(name,order), y=nod_cnt_plant)) + 
        geom_boxplot(outlier.shape=NA) +
        geom_jitter(aes(x=name, y=nod_cnt_plant, color=type)) +
        coord_flip() +
        scale_color_manual(values=cbPalette)  +
        labs(x="Plant Host",y="Nods per plant") +
        theme_classic() + theme(legend.position="top", text = element_text(size=18))
p_nod_cnt 

p_bg_nod_cnt <-ggplot(all_data, aes(x=background, y=nod_cnt_plant)) + 
        geom_boxplot(aes(x=background, y=nod_cnt_plant)) +
        geom_jitter(aes(x=background, y=nod_cnt_plant, color=type)) +
        scale_color_manual(values=cbPalette) +
        scale_fill_manual(values=c("#D55E00", "#CC79A7")) +
        labs(x="Plant Host",y="Nods per plant")+
        theme_classic() + theme(legend.position="top", text = element_text(size=18))
p_bg_nod_cnt

ggsave(plot = p_bg_nod_cnt , width = 5, height = 5, dpi = 600, filename = "../figures/bg_nod_cnt.png")

res.aov <- aov(nod_cnt_plant ~ background, data = all_data) #filter(all_data, background=="A17"))
summary(res.aov)

res.aov <- aov(nod_cnt_plant ~ type, data = filter(all_data, background=="A17"))
summary(res.aov)
TukeyHSD(res.aov)

res.aov <- aov(nod_cnt_plant ~ type, data = filter(all_data, background=="R108"))
summary(res.aov)
```

```{r total area of nodules, echo=FALSE}
p_tot_area <-ggplot(all_data, aes(x=reorder(name,order), y=tot_area_plant)) + 
        geom_boxplot(outlier.shape=NA) +
        geom_jitter(aes(x=name, y=tot_area_plant, color=type)) +
        coord_flip() +
        scale_color_manual(values=cbPalette)  +
        labs(x="Plant Host",y="Total Nod Area per plant") +
        theme_classic() + theme(legend.position="top", text = element_text(size=18))
p_tot_area 

p_bg_tot_area <-ggplot(all_data, aes(x=background, y=tot_area_plant)) + 
        geom_boxplot(aes(x=background, y=tot_area_plant)) +
        geom_jitter(aes(x=background, y=tot_area_plant, color=type)) +
        scale_color_manual(values=cbPalette) +
        scale_fill_manual(values=c("#D55E00", "#CC79A7")) +
        labs(x="Plant Host",y="Total Nod area per plant")+
        theme_classic() + theme(legend.position="top", text = element_text(size=18))
p_bg_tot_area

ggsave(plot = p_bg_tot_area , width = 5, height = 5, dpi = 600, filename = "../figures/bg_tot_area.png")

res.aov <- aov(tot_area_plant ~ background, data = all_data) #filter(all_data, background=="A17"))
summary(res.aov)

res.aov <- aov(tot_area_plant ~ type, data = filter(all_data, background=="A17"))
summary(res.aov)
TukeyHSD(res.aov)

res.aov <- aov(tot_area_plant ~ type, data = filter(all_data, background=="R108"))
summary(res.aov)
```

```{r nodule weight, echo=FALSE}
p_nod_wt <-ggplot(all_data[-171,], aes(x=reorder(name,order), y=nod_wt_plant, fill=type)) + 
        labs(x="Plant Host",y="Nod gram per plant") +
        geom_boxplot() +
        geom_point() + 
        coord_flip() +
        scale_color_manual(values=cbPalette) +
        theme_classic() + theme(legend.position="top", text = element_text(size=22))
p_nod_wt 

p_bg_nod_wt <-ggplot(all_data, aes(x=background, y=nod_wt_plant)) + 
        geom_boxplot(aes(x=background, y=nod_wt_plant)) +
        geom_jitter(aes(x=background, y=nod_wt_plant, color=type)) +
        scale_color_manual(values=cbPalette) +
        scale_fill_manual(values=c("#D55E00", "#CC79A7")) +
        labs(x="Plant Host",y="Nod gram per plant")+
        theme_classic() + theme(legend.position="top", text = element_text(size=18))
p_bg_nod_wt

ggsave(plot = p_nod_wt , width = 8, height =9, dpi = 600, filename = "../figures/nod_wt_plant.png")

res.aov <- aov(nod_wt_plant ~ background, data = all_data) #filter(all_data, background=="A17"))
summary(res.aov)

res.aov <- aov(nod_wt_plant ~ type, data = filter(all_data, background=="A17"))
summary(res.aov)
TukeyHSD(res.aov)

res.aov <- aov(nod_wt_plant ~ type, data = filter(all_data, background=="R108"))
summary(res.aov)

```

```{r strain_freq_data, echo=FALSE, warning=FALSE}
#Import data and filter dataset
#geno_name <- read.delim("~/GitHub/HostMutants2021_C86meliloti/data/genotype_name.txt", sep="\t", header=TRUE)
freq_all<-read.table("~/GitHub/HostMutants2021_C86meliloti/data/freq.tsv", header=TRUE)
#C:\Users\Lab Manager\Documents\GitHub\HostMutants2021_C86meliloti\data
#initial = M_C86_NLA-D 
#culture grow-ups = M_C86_TYA-D
#exudate experiment = X_
#alfalfa S&R = M_888-890
#Wild types = M_860, M_869

#Remove initial inoculum community, TY grow-ups, exudate experiment, and wonky alfalfa sample
freq_filtered <- freq_all %>% filter(!str_detect(sample_id, "M_C86_")) %>% filter(!str_detect(sample_id, "X_")) %>% filter(sample_id != "M_888F_S168")

#Calculate Fitness
#Subset initial inoculum community and calculate mean
freq_initial <- freq_all %>% filter(str_detect(sample_id, "M_C86_NL"))
freq_initial_mean <- as_tibble(apply(data.frame(freq_initial[,c(-1:-1)]), MARGIN = 2, mean))

#Transform raw frequency data to fitness data. log2(treatment_freq/initial_freq)
fit<-as_tibble(cbind(freq_filtered[,c(1:1)],log2(mapply("/", freq_filtered[,c(-1:-1)], freq_initial_mean))))

#After running the above line it converts values from num to chr... I think this is because the cbind is joing a chr col and a num col ? Whatever the reason the below 3 lines converts matrix values to num
fit <- as.data.frame(apply(fit, 2, as.numeric))
sample_id <- freq_filtered[,c(1:1)]
fit<- cbind(sample_id, fit[,c(2:87)])

fit <- fit %>% mutate_if(is.numeric, ~ifelse(abs(.) == Inf,-8,.)) 

#Separate sample_id 
fit <- fit %>% mutate(genotype_id = substr(sample_id, 3,5), rep = substr(sample_id, 6,6))
fit$genotype_id <- as.factor(fit$genotype_id)
geno_name$genotype_id <- as.factor(geno_name$genotype_id)
meta_fit <- inner_join(fit, geno_name, by="genotype_id")

#Remove Alfalfa
meta_fit <- meta_fit %>% filter(background!="MS")%>% filter(background!="NILS")
```

```{r fit_rda_all, echo=FALSE, fig.width=10, fig.height=15}
# RDA analysis for fitness and plot RDA1 vs RDA2 

# Run a few different RDA Models
rda1<-rda(meta_fit[,c(2:87)]~name,meta_fit, scale=TRUE) #name=genotype
rda2<-rda(meta_fit[,c(2:87)]~background,meta_fit, scale=TRUE) #background=host
rda3<-rda(meta_fit[,c(2:87)]~type,meta_fit, scale=TRUE) #type = timing of mutation
rda4<-rda(meta_fit[,c(2:87)]~background+type+name,meta_fit, scale=TRUE) 

# Rsquared gives you an overall idea of well the overall model adjusted for the number of predictors you have
mymodels<-data.frame(data=c("all"),model=c("geno_type","host","type","host+type+genotype"),
           Radj=c(RsquareAdj(rda1)$adj.r.squared,RsquareAdj(rda2)$adj.r.squared,RsquareAdj(rda3)$adj.r.squared,RsquareAdj(rda4)$adj.r.squared),
           Prop.Exp=c(summary(rda1)$constr.chi/summary(rda1)$tot.chi,summary(rda2)$constr.chi/summary(rda2)$tot.chi,summary(rda3)$constr.chi/summary(rda3)$tot.chi,summary(rda4)$constr.chi/summary(rda4)$tot.chi))
mymodels

# Run a permutational significance test for the explanatory variables in the full model
rda.model.all<-anova(rda4, step=1000, perm.max=1000, by= "terms")  
##write.table(rda.model.all,file = "../tables/RDA_All.tsv",sep="\t",col.names = NA,row.names=TRUE)

#Plot the model that explains the most: genotype
smry <- summary(rda1)
##smry
df1  <- data.frame(smry$sites[,1:2])       
df2  <- data.frame(smry$species[,1:2])     

rda1_ev <-as.vector(eigenvals(rda1, constrained=TRUE))

#copy sample_id(substring(right, 4)) in to a new column called sample_id
s_id <- substr(meta_fit$sample_id, 3,6)
m_name <- select(meta_fit, name)
m_host <- select(meta_fit, background)
m_type <- select(meta_fit, type)
df1 <- df1 %>% add_column(s_id, m_name, m_host, m_type)


rda.plot <- ggplot(df1, aes(x=RDA1, y=RDA2, color=type, shape=background)) + 
  geom_point(aes(x=RDA1, y=RDA2))+
  scale_shape_manual(values=myshapes$shapes)+
  scale_color_manual(values = mycols$cols) +
  geom_text(aes(label=name),size=4) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  labs(x=paste("RDA 1 (",round(rda1_ev[1],2),"%)"),y=paste("RDA 2 (",round(rda1_ev[2],2),"%)")) +
  theme_classic() + theme(legend.position="top", text = element_text(size=14))
rda.plot
##ggsave("../figures/rda_all.png", rda.plot, height = 12 , width = 12, dpi=300)

#rda.biplot <- rda.plot +
#  geom_segment(data=df2, aes(x=0, xend=RDA1, y=0, yend=RDA2), 
#               color="red", arrow=arrow(length=unit(0.01,"npc"))) +
#  geom_text(data=df2, 
#            aes(x=RDA1,y=RDA2,label=rownames(df2),
#                hjust=0.5*(1-sign(RDA1)),vjust=0.5*(1-sign(RDA2))), 
#            color="red", size=4)
#rda.biplot

```
Genotype: Constrained predictor explains 52% of the variance and unconstrained explain 48% of the variance.
The timing of mutation (Radj=0.09) explains less variance than host (Radj=0.27) or Genotype (Radj=0.35). 
All 3 predictors are significant 
          (df, var, F, p),
type =    (4, 3.9, 2.2, 0.001)
host=     (2, 24.8,27.6,0.001) 
Genotype= (25,16.5,1.7, 0.001)
Residuals (91,40.9,,)

I think the take away from this is that we need to take a look at genotype within a host background 

```{r fit_rda_r108, echo=FALSE}
# RDA analysis for fitness and plot RDA1 vs RDA2 
meta_fit_r108 <- meta_fit %>% filter(background=="R108") %>% filter(type!="KO/OX")
# Run a few different RDA Models
rda1<-rda(meta_fit_r108[,c(2:87)]~type,meta_fit_r108, scale=TRUE) #timing of mutation
rda2<-rda(meta_fit_r108[,c(2:87)]~name,meta_fit_r108, scale=TRUE) #genotype
rda3<-rda(meta_fit_r108[,c(2:87)]~type+name,meta_fit_r108, scale=TRUE) #
# Rsquared gives you an overall idea of well the overall model adjusted for the number of predictors you have
mymodels<-data.frame(data=c("R108"),model=c("type", "genotype", "type+genotype"),
           Radj=c(RsquareAdj(rda1)$adj.r.squared,RsquareAdj(rda2)$adj.r.squared,RsquareAdj(rda3)$adj.r.squared),
           Prop.Exp=c(summary(rda1)$constr.chi/summary(rda1)$tot.chi,summary(rda2)$constr.chi/summary(rda2)$tot.chi,summary(rda3)$constr.chi/summary(rda3)$tot.chi))
mymodels

# Run a permutational significance test for the explanatory variables in the full model
rda.model.all<-anova(rda3, step=1000, perm.max=1000, by= "terms") #
##write.table(rda.model.all,file = "../tables/RDA_r108.tsv",sep="\t",col.names = NA,row.names=TRUE)

#Plot the FULL model
smry <- summary(rda2)
#smry
df1  <- data.frame(smry$sites[,1:2])    

#copy sample_id(substring(right, 4)) in to a new column called sample_id
m_name <- select(filter(meta_fit,background=="R108" & type!="KO/OX"), name)
m_type <- select(filter(meta_fit,background=="R108" & type!="KO/OX"), type)
df1 <- df1 %>% add_column(m_name, m_type)

rda1_ev <-as.vector(eigenvals(rda2, constrained=TRUE))

rda.plot <- ggplot(df1, aes(x=RDA1, y=RDA2,color=name)) + 
  geom_point()+
  scale_color_manual(values=cbbPalette)+
  geom_text(aes(label=name),size=4) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  coord_fixed() +
  labs(x=paste("RDA 1 (",round(rda1_ev[1],2),"%)"),y=paste("RDA 2 (",round(rda1_ev[2],2),"%)"), color="Genotype") +
  theme_classic() + theme(legend.position="top", text = element_text(size=14)) 
rda.plot

##ggsave("../figures/rda_r108.png", rda.plot, height = 6 , width = 10, dpi=300)


#HEATMAP
#Get mean of just R108 wildtype and subtract from mutants, then plot those values
#Fitness mean of r108 wildtype only
fit.mean.r108wt <- meta_fit_r108 %>% filter(type=="WT") %>% group_by(name) %>% summarise_if(is.numeric,mean)

#Fitness mean of all genotypes in r108 host
fit.mean <- meta_fit_r108 %>% group_by(name) %>% summarise_if(is.numeric,mean)

#Substract mean of wildtype from mean of mutant genotypes
fit.subtract<-as_tibble(cbind(fit.mean[,c(1:1)],mapply("-",  fit.mean[,c(-1,-88)], fit.mean.r108wt[,c(-1,-88)])))

fit.subtract <- column_to_rownames(fit.subtract, "name")
fit.subtract <- fit.subtract[,-87]
pdf(file="../figures/heatmap_r108.pdf",width = 12,height=8)
h<-heatmap.2(as.matrix(fit.subtract), col=pal, trace="none", scale="row", cexCol = .5,cexRow = .75)
dev.off()
```
Genotype: Constrained predictor explains 32% of the variance and unconstrained explain 59% of the variance.
The type (WT/Late) (Radj=0.015) explains less variance than Genotype (Radj=0.12). 
ANOVA - Genotype is significant (6, 23.2, 1.6, 0.001) (df, var, F, p) (Residuals 24, 58.7)

```{r fit_rda_a17_dnf, echo=FALSE}
# RDA analysis for fitness and plot RDA1 
meta_fit_a17_dnf <- meta_fit %>% filter(background=="A17") %>% filter(str_detect(name,"dnf")|name=="A17")
# Run a few different RDA Models
rda1<-rda(meta_fit_a17_dnf[,c(2:87)]~name,meta_fit_a17_dnf, scale=TRUE) #Genotype
rda2<-rda(meta_fit_a17_dnf[,c(2:87)]~type,meta_fit_a17_dnf, scale=TRUE) #WT/DNF
rda3<-rda(meta_fit_a17_dnf[,c(2:87)]~type+name,meta_fit_a17_dnf, scale=TRUE) #both
# Rsquared gives you an overall idea of well the overall model adjusted for the number of predictors you have
mymodels<-data.frame(data=c("dnf"),model=c("genotype", "type", "both"),
          Radj=c(RsquareAdj(rda1)$adj.r.squared,RsquareAdj(rda2)$adj.r.squared,RsquareAdj(rda3)$adj.r.squared),
           Prop.Exp=c(summary(rda1)$constr.chi/summary(rda1)$tot.chi,summary(rda2)$constr.chi/summary(rda2)$tot.chi,summary(rda3)$constr.chi/summary(rda3)$tot.chi))
mymodels

# Run a permutational significance test for the explanatory variables in the full model
rda.model.all<-anova(rda3, step=1000, perm.max=1000, by= "terms") 
rda.model.all
##write.table(rda.model.all,file = "../tables/RDA_a17_dnf.tsv",sep="\t",col.names = NA,row.names=TRUE)

#Plot the FULL model 
smry <- summary(rda1)
smry
df1  <- data.frame(smry$sites[,1:2])    

#copy sample_id(substring(right, 4)) in to a new column called sample_id
m_name <- select(meta_fit_a17_dnf, name)
m_type <- select(meta_fit_a17_dnf, type)
df1 <- df1 %>% add_column(m_name, m_type)

rda1_ev <-as.vector(eigenvals(rda1, constrained=TRUE))

rda.plot <- ggplot(df1, aes(x=RDA1, y=RDA2, color=name)) + 
  geom_point()+
  scale_color_manual(values=cbbPalette)+
  geom_text(aes(label=name),size=4) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  coord_fixed() +
  labs(x=paste("RDA 1 (",round(rda1_ev[1],2),"%)"),y=paste("RDA 2 (",round(rda1_ev[2],2),"%)"), color="Genotype") +
  theme_classic() + theme(legend.position="top", text = element_text(size=14))
rda.plot
##ggsave("../figures/rda_a17_dnf.png", rda.plot, height = 6 , width = 8, dpi=300)
```
Genotype: Constrained predictor explains 42% of the variance and unconstrained explain 58% of the variance.
The type (WT/Late) (Radj=0.022) explains less variance than Genotype (Radj=0.24). 
ANOVA - Genotype is significant (7, 32.0, 2.3, 0.001) (df, var, F, p) (Residuals 25, 49.6)

```{r fit_rda_a17, echo=FALSE}
# RDA analysis for fitness and plot RDA1 vs RDA2 and RDA3 vs RDA4
meta_fit_a17 <- meta_fit %>% filter(background=="A17")
# Run a few different RDA Models
rda1<-rda(meta_fit_a17[,c(2:87)]~name,meta_fit_a17, scale=TRUE) # genotype
rda2<-rda(meta_fit_a17[,c(2:87)]~type,meta_fit_a17, scale=TRUE) # Timing of mutation
rda3<-rda(meta_fit_a17[,c(2:87)]~type+name,meta_fit_a17, scale=TRUE) # both

# Rsquared gives you an overall idea of well the overall model adjusted for the number of predictors you have
mymodels<-data.frame(data=c("A17"),model=c("genotype","type","type+genotype"),
          Radj=c(RsquareAdj(rda1)$adj.r.squared,RsquareAdj(rda2)$adj.r.squared,RsquareAdj(rda3)$adj.r.squared),
           Prop.Exp=c(summary(rda1)$constr.chi/summary(rda1)$tot.chi,summary(rda2)$constr.chi/summary(rda2)$tot.chi,summary(rda3)$constr.chi/summary(rda3)$tot.chi))
mymodels

# Run a permutational significance test for the explanatory variables in the full model
rda.model.all<-anova(rda3, step=1000, perm.max=1000, by= "terms") # 
##write.table(rda.model.all,file = "../tables/RDA_a17.tsv",sep="\t",col.names = NA,row.names=TRUE)

#Plot the FULL model with the interaction #
smry <- summary(rda1)
smry
df1  <- data.frame(smry$sites[,1:2])     

#copy sample_id(substring(right, 4)) in to a new column called sample_id
m_name <- select(filter(meta_fit,background=="A17"), name)
m_type <- select(filter(meta_fit,background=="A17"), type)
df1 <- df1 %>% add_column(m_name, m_type)

rda1_ev <-as.vector(eigenvals(rda1, constrained=TRUE))

rda.plot <- ggplot(df1, aes(x=RDA1, y=RDA2, color=type, shape=type)) + 
  geom_point()+
  scale_shape_manual(values=c(15, 16, 17, 18))+
  scale_color_manual(values=cbbPalette)+
  geom_text(aes(label=name),size=4) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  coord_fixed() +
  labs(x=paste("RDA 1 (",round(rda1_ev[1],2),"%)"),y=paste("RDA 2 (",round(rda1_ev[2],2),"%)")) +
  theme_classic() + theme(legend.position="top", text = element_text(size=14))
rda.plot
##ggsave("../figures/rda_a17.png", rda.plot, height = 7 , width = 12, dpi=300)

#HEATMAP
#Get mean of just A17 wildtype and subtract from mutants, then plot those values
#Fitness mean of a17 wildtype only
fit.mean.a17wt <- meta_fit_a17 %>% filter(type=="WT") %>% group_by(name) %>% summarise_if(is.numeric,mean)

#Fitness mean of all genotypes in a17 host
fit.mean <- meta_fit_a17 %>% group_by(name) %>% summarise_if(is.numeric,mean)

#Substract mean of wildtype from mean of mutant genotypes
fit.subtract<-as_tibble(cbind(fit.mean[,c(1:1)],mapply("-",  fit.mean[,c(-1,-88)], fit.mean.a17wt[,c(-1,-88)])))

fit.subtract <- column_to_rownames(fit.subtract, "name")
fit.subtract <- fit.subtract[,-87]
pdf(file="../figures/heatmap_a17.pdf",width = 12,height=8)
h<-heatmap.2(as.matrix(fit.subtract), col=pal, trace="none", scale="row", cexCol = .5,cexRow = .75)
dev.off()
```
Genotype: Constrained predictor explains 39% of the variance and unconstrained explain 61% of the variance.
The type or Timing of Mutation (Radj=0.04) explains less variance than Genotype (Radj=0.36). 
ANOVA -  var,  p 
Genotype 25.4, 0.001 
type     7.8 , 0.004
Residual 49.6
 
```{r fit_rda_MS, include=FALSE}
# RDA analysis for fitness and plot RDA1 vs RDA2 
meta_fit_MS <- meta_fit %>% filter(background=="MS")
# Run the only possible RDA Model
rda1<-rda(meta_fit_MS[,c(2:87)]~name,meta_fit_MS, scale=TRUE) # Time only

# Rsquared gives you an overall idea of well the overall model adjusted for the number of predictors you have
mymodels<-data.frame(data=c("all"),model=c("genotype"),
           Radj=c(RsquareAdj(rda1)$adj.r.squared),
           Prop.Exp=c(summary(rda1)$constr.chi/summary(rda1)$tot.chi))
mymodels
# The adjusted r-squared for the model allowing for an interaction between Time and Treatment has the highest rsquared even when penalized for the additional predictors
# Run a permutational significance test for the explanatory variables in the full model
# In this case the inference from the anova aligns with the inference from the adjusted R squared 

rda.model.all<-anova(rda1, step=1000, perm.max=1000, by= "terms") # The interaction is significant, but temperature has the largest effect
write.table(rda.model.all,file = "../tables/RDA_MS_type.tsv",sep="\t",col.names = NA,row.names=TRUE)

#Plot the FULL model with the interaction #
smry <- summary(rda1)
df1  <- data.frame(smry$sites[,1:2])       # PC1 and PC2
#df2  <- data.frame(smry$species[,1:2])     # loadings for PC1 and PC2

#copy sample_id(substring(right, 4)) in to a new column called sample_id
m_name <- select(filter(meta_fit,background=="MS" & type!="UN"), name)
m_type <- select(filter(meta_fit,background=="MS" & type!="UN"), type)
df1 <- df1 %>% add_column(m_name, m_type)

rda1_ev <-as.vector(eigenvals(rda1, constrained=TRUE))

rda.plot <- ggplot(df1, aes(x=RDA1, y=RDA2, color=name)) + 
  geom_point()+
  scale_shape_manual(values=c(15, 16, 17, 18))+
  scale_color_manual(values=cbbPalette)+
  geom_text(aes(label=name),size=4) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  coord_fixed() +
  labs(x=paste("RDA 1 (",round(rda1_ev[1],2),"%)"),y=paste("RDA 2 (",round(rda1_ev[2],2),"%)")) +
  theme_classic() + theme(legend.position="top", text = element_text(size=14))
rda.plot
ggsave("../figures/rda_MS.png", rda.plot, height = 15 , width = 10, dpi=300)
```

```{r fit_rda_NILS, include=FALSE}
# RDA analysis for fitness and plot RDA1 vs RDA2 and RDA3 vs RDA4
meta_fit_A18 <- meta_fit %>% filter(background=="NILS") %>% filter(type!="UN")
# Run a few different RDA Models
#rda1<-rda(meta_fit_A18[,c(2:87)]~type,meta_fit_A18, scale=TRUE) # Time only
rda1<-rda(meta_fit_A18[,c(2:87)]~name,meta_fit_A18, scale=TRUE) # Time only
#rda3<-rda(meta_fit_A18[,c(2:87)]~type*name,meta_fit_A18, scale=TRUE) # Time only
#rda4<-rda(meta_fit_A18[,c(2:87)]~type+name,meta_fit_A18, scale=TRUE) # Time only
# Rsquared gives you an overall idea of well the overall model adjusted for the number of predictors you have
mymodels<-data.frame(data=c("NILS"),model=c("genotype"),
           Radj=c(RsquareAdj(rda1)$adj.r.squared),
           Prop.Exp=c(summary(rda1)$constr.chi/summary(rda1)$tot.chi))
mymodels
# The adjusted r-squared for the model allowing for an interaction between Time and Treatment has the highest rsquared even when penalized for the additional predictors
# Run a permutational significance test for the explanatory variables in the full model
# In this case the inference from the anova aligns with the inference from the adjusted R squared 

rda.model.all<-anova(rda1, step=1000, perm.max=1000, by= "terms") # The interaction is significant, but temperature has the largest effect
write.table(rda.model.all,file = "../tables/RDA_A18_type.tsv",sep="\t",col.names = NA,row.names=TRUE)

#Plot the FULL model with the interaction #
smry <- summary(rda1)
df1  <- data.frame(smry$sites[,1:2])       # PC1 and PC2
#df2  <- data.frame(smry$species[,1:2])     # loadings for PC1 and PC2

#copy sample_id(substring(right, 4)) in to a new column called sample_id
m_name <- select(filter(meta_fit,background=="NILS" & type!="UN"), name)
m_type <- select(filter(meta_fit,background=="NILS" & type!="UN"), type)
df1 <- df1 %>% add_column(m_name, m_type)

rda1_ev <-as.vector(eigenvals(rda1, constrained=TRUE))

rda.plot <- ggplot(df1, aes(x=RDA1, y=RDA2)) + 
  geom_point(aes(color=type,shape=name), size=4)+
  scale_shape_manual(values=c(15, 16, 17, 18))+
  scale_color_manual(values=mypal[c(5)])+
  geom_text(aes(label=name),size=4) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  coord_fixed() +
  labs(x=paste("RDA 1 (",round(rda1_ev[1],2),"%)"),y=paste("RDA 2 (",round(rda1_ev[2],2),"%)")) +
  theme_classic() + theme(legend.position="top", text = element_text(size=14))
rda.plot
ggsave("../figures/rda_NILS.png", rda.plot, height = 6 , width = 8, dpi=300)
```

```{r fit_rda_ko, include=FALSE}
# RDA analysis for fitness and plot RDA1 vs RDA2 and RDA3 vs RDA4
meta_fit_ko <- meta_fit %>% filter(type=="KO/OX")
# Run a few different RDA Models
rda1<-rda(meta_fit_ko[,c(2:87)]~name,meta_fit_ko, scale=TRUE) # Time only
#rda2<-rda(meta_fit_ko[,c(2:87)]~type,meta_fit_ko, scale=TRUE) # Time only
#rda3<-rda(meta_fit_ko[,c(2:87)]~type+name,meta_fit_ko, scale=TRUE) # Time only
#rda4<-rda(meta_fit_ko[,c(2:87)]~type+name,meta_fit_ko, scale=TRUE) # Time only
# Rsquared gives you an overall idea of well the overall model adjusted for the number of predictors you have
mymodels<-data.frame(data=c("KO/OX"),model=c("genotype"),
           Radj=c(RsquareAdj(rda1)$adj.r.squared),
           Prop.Exp=c(summary(rda1)$constr.chi/summary(rda1)$tot.chi))
mymodels
# The adjusted r-squared for the model allowing for an interaction between Time and Treatment has the highest rsquared even when penalized for the additional predictors
# Run a permutational significance test for the explanatory variables in the full model
# In this case the inference from the anova aligns with the inference from the adjusted R squared 

rda.model.all<-anova(rda1, step=1000, perm.max=1000, by= "terms") # The interaction is significant, but temperature has the largest effect
rda.model.all
write.table(rda.model.all,file = "../tables/RDA_ko_genotype.tsv",sep="\t",col.names = NA,row.names=TRUE)

#Plot the FULL model with the interaction #
smry <- summary(rda1)
df1  <- data.frame(smry$sites[,1:4])       # PC1 and PC2
#df2  <- data.frame(smry$species[,1:4])     # loadings for PC1 and PC2

#copy sample_id(substring(right, 4)) in to a new column called sample_id
m_name <- select(filter(meta_fit, type=="KO/OX"), name)
m_type <- select(filter(meta_fit,type=="KO/OX"), type)
df1 <- df1 %>% add_column(m_name, m_type)

rda1_ev <-as.vector(eigenvals(rda1, constrained=TRUE))

rda.plot <- ggplot(df1, aes(x=RDA1, y=RDA2)) + 
  geom_point(aes(color=type,shape=name), size=4)+
  scale_shape_manual(values=c(15, 16, 17, 18))+
  scale_color_manual(values=mypal[3])+
  geom_text(aes(label=name),size=4) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  coord_fixed() +
  labs(x=paste("RDA 1 (",round(rda1_ev[1],2),"%)"),y=paste("RDA 2 (",round(rda1_ev[2],2),"%)")) +
  theme_classic() + theme(legend.position="top", text = element_text(size=14))
rda.plot
ggsave("../figures/rda_ko.png", rda.plot, height = 6 , width = 8, dpi=300)

rda.plot <- ggplot(df1, aes(x=RDA2, y=RDA3)) + 
  geom_point(aes(color=type,shape=name), size=4)+
  scale_shape_manual(values=c(15, 16, 17, 18))+
  scale_color_manual(values=mypal[3])+
  geom_text(aes(label=name),size=4) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  coord_fixed() +
  labs(x=paste("RDA 2 (",round(rda1_ev[2],2),"%)"),y=paste("RDA 3 (",round(rda1_ev[3],2),"%)")) +
  theme_classic() + theme(legend.position="top", text = element_text(size=14))
rda.plot
ggsave("../figures/rda_ko_rda2&3.png", rda.plot, height = 6 , width = 8, dpi=300)
```


```{r freq_diversity, echo=FALSE}
#freq table with sample info
#Separate sample_id 
freq <- freq_filtered %>% mutate(genotype_id = substr(sample_id, 3,5), rep = substr(sample_id, 6,6)) 
freq <- inner_join(freq, geno_name, by="genotype_id") 
freq<- freq %>% filter(type!="UN") %>% filter(background!="MS")

freq_div <-data.frame(shannon=diversity(as.matrix(freq[,c(-1:-1,-87:-93)]), index = "shannon"),Trt=factor(freq$background),Type=factor(freq$type), genotype_id=factor(freq$genotype_id))

freq_div <- inner_join(freq_div, geno_name)

invsimpson = diversity(as.matrix(freq[,c(-1:-1,-87:-93)]), index = "invsimpson")
freq_div <- freq_div %>% add_column(invsimp = invsimpson)

anova(lm(shannon~Trt*Type,data=freq_div)) # First pass anova shows 
summary(lm(shannon~Trt*Type,data=freq_div)) # Examination of coeffecients suggests T

anova(lm(invsimpson~Trt*Type,data=freq_div)) # First pass anova shows 
summary(lm(invsimpson~Trt*Type,data=freq_div)) # Examination of coeffecients suggests T

p<-ggplot(data=freq_div, aes(x=reorder(name, order), y=shannon, fill=type)) +
  geom_boxplot() +
  geom_point() + 
  coord_flip() +
  scale_fill_manual(values=mycols$cols) +
  labs(x="Plant Host",y="Shannon diversity") +
  theme_classic() + theme(legend.position="top", text = element_text(size=22))
p

ggsave("../figures/shannon.png", p, height = 9 , width = 8, dpi=300)

p<-ggplot(data=freq_div, aes(x=reorder(name, order), y=invsimpson, fill=Type)) +
  geom_boxplot() +
  geom_point() +
  scale_fill_manual(values=mycols$cols) +
  coord_flip() +
  theme_classic()
p
ggsave("../figures/invsimpson.png", p, height = 10 , width = 10, dpi=300)
```

```{r heatmap_means, include=FALSE}

#USED FOR DEV. HEAT MAPS ARE GENERATED BELOW RDAS. SEE FIGURES FOLDER

#HEAT MAP

####NEED TO MAKE THIS MEANS
#Calculate median fitness and plot PCA
#Take Median of fitness
fit.med <- meta_fit_a17_dnf %>% group_by(name) %>% summarise_if(is.numeric,median)
fit.mean <- meta_fit_a17_dnf %>% group_by(name) %>% summarise_if(is.numeric,mean)
df_long <- pivot_longer(fit.med[,1:87],"MAG5":"MAG761A", names_to="Mag", values_to="value")

p<- ggplot(df_long, aes(x = name, y = Mag, fill = value)) +
  geom_tile(color = "black") +
  scale_fill_viridis_b()
p

ggsave(plot = p , width = 12, height = 12, dpi = 600, filename = "../figures/heat_a17_dnf.png")

fit.med <- column_to_rownames(fit.med, "name")
fit.med <- fit.med[,-87]
#l = length(seq(-7.9, 5, 0.1))
pal = as.vector(c("#2166AC", "#F7F7F7", "#B2182B"))
pdf(file="../figures/heatbase.pdf")
h <- heatmap(t(fit.med))
dev.off()


fit.mean <- column_to_rownames(fit.mean, "name")
fit.mean <- fit.mean[,-87]
l = length(seq(-7.9, 8, 0.1))
pal = colorRampPalette(c('#2166AC', '#F7F7F7', '#B2182B'))(l)
#pal = as.vector(c("#2166AC", "#F7F7F7", "#B2182B"))
pdf(file="../figures/heatbase_mean.pdf",width = 8,height=8)
h <- heatmap(as.matrix(fit.mean),col=pal,cexCol = .5,cexRow = .75)
h <- heatmap(as.matrix(fit.med),col=pal,cexCol = .5,cexRow = .75)
dev.off()

fit.mean.all <- meta_fit %>% group_by(name) %>% summarise_if(is.numeric,mean)
fit.mean.all <- column_to_rownames(fit.mean.all, "name")
fit.mean.all <- fit.mean.all[,-87]
l = length(seq(-7.9, 8, 0.1))
pal = colorRampPalette(c('#2166AC', '#F7F7F7', '#B2182B'))(l)
#pal = as.vector(c("#2166AC", "#F7F7F7", "#B2182B"))
pdf(file="../figures/heatbase_mean_all.pdf",width = 8,height=8)
h <- heatmap(as.matrix(fit.mean.all),col=pal,cexCol = .5,cexRow = .75)
dev.off()
```
